# Мелкие рекомендации (backlog)

> **Обновлено:** 16.02.2026
> **Назначение:** Некритичные улучшения для будущей реализации

---

## Формат записи

```markdown
### N. Краткое описание проблемы
- **Файл:** `путь/к/файлу.ts:строка`
- **Суть:** Описание проблемы
- **Исправление:** Что нужно сделать
- **Источник:** Review (дата)
- **Статус:** Открыто / Готово
- **Приписка (при исправлении):** <ИмяАгента> (DD.MM.YYYY): Исправил. <Детали>
```

---

## P0 — Критические (требуют немедленного исправления)

### 1. TypeScript check упал — отсутствует поле `content` в NewsItem
- **Файлы:**
  - `src/lib/types.ts:1-12` (интерфейс)
  - `src/lib/server/db/news-repository.ts:67-68`
  - `src/lib/server/news-service.ts:73,137,148`
  - `src/lib/server/jobs/feed-fetcher.ts:94,257,265,301,307`
  - `src/lib/server/news-utils.test.ts:88-124`
- **Суть:** Интерфейс `NewsItem` не содержит поле `content`, но оно используется в БД, репозитории, сервисах и тестах. `npm run check` падает с 16 ошибками.
- **Исправление:** Добавить `content?: string` в интерфейс `NewsItem`
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Добавил в `NewsItem` поля `content?: string` и `originalContent?: string`, синхронизировал тип с фактическим использованием в backend.

---

## P1 — Важные (перед Stage 5 Deploy)

### 2. news-service.ts помечен @deprecated, но активно используется
- **Файл:** `src/lib/server/sources/index.ts:7`
- **Суть:** Функция `createNewsSources()` помечена deprecated, но используется в `+page.server.ts` как fallback при недоступности БД
- **Исправление:** Убрать комментарий `@deprecated` или полностью удалить fallback
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Убрал `@deprecated`, оставил fallback и уточнил комментарий.

### 3. Типы 'arxiv' и 'api' остались в NewsSource.type
- **Файл:** `src/lib/server/types.ts:26`
- **Суть:** После Stage 7 ArXiv и NewsData были удалены, но типы `'api'` и `'arxiv'` остались в интерфейсе
- **Исправление:** Обновить на `type: 'rss'` (или `'rss' | 'reddit'`, если Reddit планируется)
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Обновил `NewsSource.type` до `type: 'rss'`.

### 4. Тип 'reddit' объявлен, но Reddit-источник не реализован
- **Файл:** `src/lib/server/types.ts:26`
- **Суть:** В `NewsSource.type` есть `'reddit'`, но Reddit-источника нет в коде
- **Исправление:** Если Reddit не планируется — убрать из типов
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Удалил `'reddit'` из union-типа `NewsSource.type`.

### 5. Dead code — поля суммаризации в schema.ts не используются
- **Файл:** `src/lib/server/db/schema.ts:50-53`
- **Суть:** Поля `summary`, `isSummarized`, `summaryModel` не используются. Суммаризация не реализована
- **Исправление:** Удалить поля + создать миграцию, или обновить комментарий на "(future Stage)"
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Оставил поля для будущей функциональности и обновил комментарий на `(future stage, пока не используется)`.

---

## P2 — Рекомендации (можно отложить)

### 6. imageUrl в schema.ts не используется после Stage 7
- **Файл:** `src/lib/server/db/schema.ts:43`
- **Суть:** После удаления изображений поле `imageUrl` осталось в БД, но нигде не используется
- **Исправление:** Удалить поле + миграция: `ALTER TABLE articles DROP COLUMN image_url;`
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Удалил `imageUrl` из Drizzle-схемы и добавил миграцию `drizzle/0001_drop_articles_image_url.sql`.

### 7. Комментарий в schema.ts устарел
- **Файл:** `src/lib/server/db/schema.ts:20`
- **Суть:** Комментарий `// 'rss' | 'api' | 'arxiv'` не синхронизирован с реальностью
- **Исправление:** Обновить на `// 'rss'`
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Обновил комментарий в `schema.ts` на `// 'rss'`.

### 8. createNewsSources() используется только в одном месте
- **Файл:** `src/lib/server/sources/index.ts:8`
- **Суть:** Функция экспортируется, но используется только в `news-service.ts` (fallback)
- **Исправление:** Оставить, если fallback важен. Связано с пунктом 2
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Оставил экспорт осознанно; используется в fallback-пайплайне `news-service.ts`.

### 9. docs/archive/TECHNICAL_PLAN_ARCHIVE.md (53 KB)
- **Файл:** `docs/archive/TECHNICAL_PLAN_ARCHIVE.md`
- **Суть:** Большой архивный документ (53 КБ)
- **Исправление:** Удалить, если не нужен для истории
- **Источник:** Review 16.02.2026-15-03
- **Статус:** Готово ✅
- **Приписка (при исправлении):** Codex (16.02.2026): Удалил архивный файл из репозитория как неиспользуемый.

---

## Замечания из ревью 19.02.2026

### P0 — Критические

### 10. deploy.yml: миграции ПОСЛЕ старта приложения + `|| true` скрывает ошибки
- **Файл:** `.github/workflows/deploy.yml:19-32`
- **Суть:** Приложение стартует ДО применения миграций (race condition). `|| true` скрывает сбои миграции.
- **Исправление:** Перенести `drizzle-kit migrate` до `docker compose up`. Убрать `|| true`.
- **Источник:** Review 19.02.2026-15-20
- **Статус:** Открыто

### 11. deploy.yml: `drizzle-kit` недоступен в production контейнере
- **Файл:** `Dockerfile:14`, `.github/workflows/deploy.yml:31`
- **Суть:** После `npm prune --production` drizzle-kit (devDependency) удаляется. `npx drizzle-kit migrate` упадёт в production контейнере.
- **Исправление:** Рекомендуется — `drizzle-orm/migrator` API при старте приложения в `hooks.server.ts`.
- **Источник:** Review 19.02.2026-15-20
- **Статус:** Открыто

---

### P1 — Важные

### 12. `onMount` вместо `$effect` в +page.svelte
- **Файл:** `src/routes/+page.svelte:1,46`
- **Суть:** Svelte 4 API `onMount`. Конвенция проекта требует `$effect`.
- **Исправление:** Заменить `onMount(() => {...})` на `$effect(() => {...})`.
- **Источник:** Review 19.02.2026-15-20
- **Статус:** Открыто

### 13. `getNewsById` — dead code в news-repository.ts
- **Файл:** `src/lib/server/db/news-repository.ts:131`
- **Суть:** Нигде не используется (детальных страниц нет с Stage 7).
- **Исправление:** Удалить строки 131-175.
- **Источник:** Review 19.02.2026-15-20
- **Статус:** Открыто

### 14. `/api/articles` — нет документации о публичности endpoint
- **Файл:** `src/routes/api/articles/+server.ts:8`
- **Суть:** Открыт без авторизации, решение публичности не задокументировано.
- **Исправление:** Добавить комментарий или защиту API ключом.
- **Источник:** Review 19.02.2026-15-20
- **Статус:** Открыто

---

### P2 — Рекомендации

### 15. `telegram_sent_articles` — нет TTL/cleanup
- **Файл:** `src/lib/server/db/schema.ts:85`, `src/lib/server/jobs/feed-fetcher.ts`
- **Суть:** Таблица растёт без ограничений, нет удаления старых записей.
- **Исправление:** Добавить cleanup в `deleteOldNews()` по `sentAt < cutoffDate`.
- **Источник:** Review 19.02.2026-15-20
- **Статус:** Открыто

### 16. deploy.yml — нет CI проверок перед деплоем
- **Файл:** `.github/workflows/deploy.yml`
- **Суть:** Деплой без предварительного `check` и `test:run`.
- **Исправление:** Добавить job `check` с `needs: check`.
- **Источник:** Review 19.02.2026-15-20
- **Статус:** Открыто

---

## Архив исправленных (Stage 1-7)

Предыдущие замечания (1-28) были исправлены после Stage 7 Overhaul.
Для истории см. `git log` или `docs/archive/`.

---

**Последнее обновление:** 19.02.2026 15:20
**Статус:** 2 P0, 3 P1, 2 P2 — всего 7 открытых задач
